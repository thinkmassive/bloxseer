---
version: '2.1'

volumes:
  etcd:

services:
  aperture:
    image: lightninglabs/aperture:v0.1.18-beta
    network_mode: host
    volumes:
      - ./aperture/aperture.yaml:/root/.aperture/aperture.yaml
      - ./aperture/static:/root/.aperture/static
      - ./aperture/lnd:/root/.lnd
    logging:
      driver: "json-file"
      options:
        max-size: 100m
        max-file: '2'
    depends_on:
      - api

  api:
    build:
      context: ./api
    image: bloxseer:v0.1.0-alpha
    environment:
      - FLASK_APP=/app/api.py
    command: ["python", "-m", "flask", "run", "--host=0.0.0.0"]
    ports:
      - "5000:5000"
    logging:
      driver: "json-file"
      options:
        max-size: 100m
        max-file: '2'

  bitcoin-s:
    image: bitcoinscala/bitcoin-s-server:latest
    command: ['--conf','/home/bitcoin-s/.bitcoin-s/bitcoin-s.conf']
    environment:
      - 'BITCOIN_S_NETWORK=testnet3'
      - 'BITCOIN_S_NODE_MODE=neutrino'
      - 'BITCOIN_S_NODE_PEERS=neutrino.testnet.lightningcluster.com:18333'
      - 'BITCOIN_S_RPC_BIND=0.0.0.0'
      - 'BITCOIN_S_SERVER_RPC_PASSWORD=bloxseer'
      #- 'BITCOIN_S_NODE_PEERS=neutrino.testnet3.suredbits.com:18333,neutrino.testnet.lightningcluster.com:18333'
      #- 'BITCOIN_S_NODE_PEERS=neutrino.testnet3.suredbits.com:18333'
    ports:
      - "9999:9999"
      - "19999:19999"
    volumes:
      - ./bitcoin-s:/home/bitcoin-s/.bitcoin-s/

  # https://github.com/bitnami/bitnami-docker-etcd
  etcd:
    image: bitnami/etcd:3.5.3
    restart: unless-stopped
    ports:
      - 2379:2379
      - 2380:2380
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_AUTO_COMPACTION_MODE=revision
    volumes:
      - etcd:/bitnami/etcd
    logging:
      driver: "json-file"
      options:
        max-size: 100m
        max-file: '2'
